{
  "input" : {
    "search" : {
      "request" : {
        "indices" : [ "docker" ],
        "types" : [ "event" ],
        "body" : {
          "size": 0,
          "query": {"range": {"@timestamp": {"gte": "now-10m"}}},
          "aggs": {
            "containers": {
              "terms": {"field": "type_instance.keyword"},
              "aggs": {
                "most_recent": {
                  "top_hits": {
                    "sort": [{"@timestamp": {"order": "desc"}}],
                    "size" : 1
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "trigger" : {
    "schedule" : {
      "interval" : "10m"
    }
  },
  "condition" : {
    "always" : {}
  },
  "actions" : {
    "index_payload" : { 
      "transform" : { 
        "chain": [
          { "script": "List ret = []; for (def x : ctx.aggregations.containers.buckets) { ret.add(x.most_recent.hits.hits.0._source); } return [ '_doc': ret] " }
        ]
      },
      "index" : {
        "index" : "container-performance", 
        "doc_type" : "container-stats"
      }
    }
  }
}

